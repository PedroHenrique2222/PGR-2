<!DOCTYPE html>
<html lang="pt-BR" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo - Portal GR</title>
    <link rel="icon" type="image/png" href="Imagens/FV.png">
    
    <!-- Bibliotecas CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lora&family=Montserrat&family=Roboto+Slab&display=swap" rel="stylesheet">
    
    <!-- CSS Unificado -->
    <link rel="stylesheet" href="styles/style.css">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'primary': '#0D47A1', 'primary-dark': '#1565C0',
                        'light-bg': '#F7FAFC', 'dark-bg': '#1A202C',
                        'dark-card': '#2D3748'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <!-- Seção de Login -->
    <div id="login-section" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white dark:bg-dark-card p-8 rounded-lg shadow-md w-full max-w-md">
            <h2 class="text-2xl font-bold text-center mb-6">Acesso Restrito</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="email" class="block text-gray-700 dark:text-gray-300 mb-2">Email</label>
                    <input type="email" id="email" class="w-full px-3 py-2 border dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-gray-700 dark:text-gray-300 mb-2">Senha</label>
                    <input type="password" id="password" class="w-full px-3 py-2 border dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary" required>
                </div>
                <button type="submit" id="login-button" class="w-full bg-primary text-white py-2 rounded-lg hover:bg-primary-dark transition-colors flex items-center justify-center">
                    <span id="login-button-text">Entrar</span>
                    <i id="login-spinner" class="fas fa-spinner fa-spin hidden ml-2"></i>
                </button>
                <p id="login-error" class="text-red-500 text-sm mt-4 text-center"></p>
            </form>
        </div>
    </div>

    <!-- Painel Administrativo -->
    <div id="admin-panel" class="hidden">
        <header class="bg-white dark:bg-dark-card shadow-md sticky top-0 z-30">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <h1 class="text-xl font-bold">Painel Administrativo</h1>
                    <span class="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded-full dark:bg-purple-900 dark:text-purple-200 border border-purple-200 dark:border-purple-700 hidden sm:inline-block">
                        <i class="fas fa-magic mr-1"></i> AI Powered
                    </span>
                </div>
                <div class="flex items-center gap-2 md:gap-4">
                    <button id="theme-toggle" class="text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-blue-400 focus:outline-none p-2" title="Alternar tema">
                        <i id="theme-icon" class="fas fa-moon fa-lg"></i>
                    </button>
                    <button id="logout-button" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors text-sm font-bold ml-2">Sair</button>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Dashboard Stats -->
            <section id="dashboard-section" class="mb-8">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="dashboard-card bg-white dark:bg-dark-card p-6 rounded-lg shadow-md">
                        <h3 class="font-bold mb-2 text-gray-500 dark:text-gray-400 text-sm uppercase tracking-wide">Visão Geral</h3>
                        <div class="flex items-center gap-4 mt-2">
                            <div class="w-12 h-12 rounded-full bg-blue-100 dark:bg-blue-900 flex items-center justify-center">
                                <i class="fas fa-newspaper fa-lg text-primary dark:text-blue-400"></i>
                            </div>
                            <div>
                                <p class="text-gray-500 dark:text-gray-400 text-xs">Total de Notícias</p>
                                <p id="stats-total-news" class="text-3xl font-bold">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="dashboard-card bg-white dark:bg-dark-card p-6 rounded-lg shadow-md col-span-1 md:col-span-2">
                         <h3 class="font-bold mb-2 text-gray-500 dark:text-gray-400 text-sm uppercase tracking-wide">Distribuição por Categoria</h3>
                         <!-- Container corrigido para o gráfico -->
                         <div class="relative h-64 w-full">
                            <canvas id="categories-chart"></canvas>
                         </div>
                    </div>
                </div>
            </section>

            <div class="grid grid-cols-1 gap-8">
                <!-- Formulário de Notícia -->
                <div id="form-container" class="hidden">
                    <div class="bg-white dark:bg-dark-card p-6 rounded-lg shadow-xl border border-gray-200 dark:border-gray-700">
                        <div class="flex justify-between items-center mb-6 border-b dark:border-gray-700 pb-4">
                            <h2 id="form-title" class="text-2xl font-bold text-gray-800 dark:text-white">Adicionar Nova Notícia</h2>
                            <button onclick="checkUnsavedChanges()" class="text-gray-400 hover:text-red-500 transition-colors p-2"><i class="fas fa-times fa-lg"></i></button>
                        </div>
                        
                        <form id="news-form" onsubmit="return false;">
                            <input type="hidden" id="news-id">
                            <input type="hidden" id="base64-image">
                            
                            <div class="grid md:grid-cols-3 gap-6">
                                <!-- Coluna Esquerda: Dados -->
                                <div class="md:col-span-2 space-y-5">
                                    <div>
                                        <div class="flex justify-between items-center mb-1">
                                            <label class="block text-gray-700 dark:text-gray-300 font-semibold text-sm">Título Principal <span class="text-red-500">*</span></label>
                                            <button type="button" onclick="generateTitleIdeas()" id="ai-title-btn" class="text-[10px] uppercase font-bold text-white ai-btn-gradient px-2 py-1 rounded shadow flex items-center gap-1">
                                                <i class="fas fa-lightbulb"></i> <span>Ideias</span>
                                            </button>
                                        </div>
                                        <input type="text" id="title" class="w-full px-4 py-2 border dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all" required oninput="updateCharCount(this, 'title-count'); markDirty();">
                                        <div class="text-right text-xs text-gray-400 mt-1"><span id="title-count">0</span> caracteres</div>
                                    </div>
                                    <div>
                                        <div class="flex justify-between items-center mb-1">
                                            <label class="block text-gray-700 dark:text-gray-300 font-semibold text-sm">Linha Fina (Subtítulo)</label>
                                            <button type="button" onclick="generateSubtitle()" id="ai-subtitle-btn" class="text-[10px] uppercase font-bold text-white ai-btn-gradient px-2 py-1 rounded shadow flex items-center gap-1">
                                                <i class="fas fa-magic"></i> <span>Gerar</span>
                                            </button>
                                        </div>
                                        <textarea id="subtitle" rows="3" class="w-full px-4 py-2 border dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all resize-none" maxlength="160" oninput="updateCharCount(this, 'subtitle-count', 160); markDirty();"></textarea>
                                        <div class="text-right text-xs text-gray-400 mt-1"><span id="subtitle-count">0</span>/160</div>
                                    </div>
                                </div>
                                
                                <!-- Coluna Direita: Capa -->
                                <div>
                                    <label class="block text-gray-700 dark:text-gray-300 mb-2 font-bold text-sm">Imagem de Capa</label>
                                    <div class="image-preview-container mb-3 shadow-inner" id="drop-area">
                                        <img id="image-preview" src="" alt="Pré-visualização" class="hidden">
                                        <div id="placeholder-text" class="text-gray-400 text-center p-4">
                                            <i class="fas fa-image fa-2x mb-2 text-gray-300"></i>
                                            <p class="text-xs font-semibold">Clique para enviar</p>
                                        </div>
                                        <div id="processing-overlay" class="processing-overlay hidden">
                                            <i class="fas fa-circle-notch fa-spin fa-2x text-primary"></i>
                                            <span class="text-xs font-bold mt-2">Processando...</span>
                                        </div>
                                    </div>
                                    <input type="file" id="imageInput" accept="image/*" class="hidden" />
                                    
                                    <div class="flex gap-2 text-xs mb-2">
                                        <button type="button" onclick="document.getElementById('imageInput').click()" class="flex-1 bg-gray-200 dark:bg-gray-700 py-2 rounded font-medium hover:bg-gray-300 transition-colors">Upload</button>
                                        <button type="button" onclick="promptUrlImage()" class="flex-1 bg-gray-200 dark:bg-gray-700 py-2 rounded font-medium hover:bg-gray-300 transition-colors">Link URL</button>
                                    </div>
                                    <button type="button" id="re-crop-btn" onclick="reCropImage()" class="hidden w-full bg-blue-100 text-blue-700 py-2 rounded text-xs font-bold hover:bg-blue-200 mb-2 transition-colors"><i class="fas fa-crop-alt mr-1"></i> Ajustar Recorte</button>
                                    
                                    <input type="text" id="imageCredit" placeholder="Créditos da foto (Opcional)" class="w-full px-3 py-2 text-xs border dark:border-gray-600 rounded bg-transparent focus:ring-1 focus:ring-primary outline-none" oninput="markDirty()">
                                </div>
                            </div>

                            <div class="grid md:grid-cols-2 gap-6 mt-2">
                                <div>
                                    <label class="block text-gray-700 dark:text-gray-300 mb-1 text-sm font-semibold">Categoria <span class="text-red-500">*</span></label>
                                    <select id="category" class="w-full px-4 py-2 border dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none" onchange="markDirty()">
                                        <option value="">Selecione...</option>
                                        <option value="Geral">Geral</option>
                                        <option value="Política">Política</option>
                                        <option value="Esporte">Esporte</option>
                                        <option value="Educação">Educação</option>
                                        <option value="Saúde">Saúde</option>
                                        <option value="Cultura">Cultura</option>
                                        <option value="Polícia">Polícia</option>
                                    </select>
                                </div>
                                <div>
                                    <div class="flex justify-between items-center mb-1">
                                        <label class="block text-gray-700 dark:text-gray-300 text-sm font-semibold">Tags</label>
                                        <button type="button" onclick="generateTags()" id="ai-tags-btn" class="text-[10px] uppercase font-bold text-white ai-btn-gradient px-2 py-1 rounded shadow flex items-center gap-1">
                                            <i class="fas fa-tags"></i> <span>Sugerir</span>
                                        </button>
                                    </div>
                                    <input type="text" id="tags" class="w-full px-4 py-2 border dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none" placeholder="Ex: prefeitura, obras, verba" oninput="markDirty()">
                                </div>
                            </div>

                            <!-- EDITOR -->
                            <div class="mt-8" id="editor-wrapper">
                                <div class="flex justify-between items-end mb-2">
                                    <label class="block text-gray-700 dark:text-gray-300 font-bold text-lg">Conteúdo da Notícia</label>
                                    <div class="flex gap-2">
                                        <button type="button" onclick="improveContent()" id="ai-review-btn" class="text-xs text-white ai-btn-gradient px-3 py-1.5 rounded border border-transparent transition shadow">
                                            <i class="fas fa-sparkles mr-1"></i> Revisar Texto
                                        </button>
                                        <button type="button" onclick="insertMediaModal()" class="text-xs bg-gray-100 text-gray-700 px-3 py-1.5 rounded hover:bg-gray-200 border border-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600 transition">
                                            <i class="fas fa-photo-video mr-1"></i> Mídia
                                        </button>
                                        <button type="button" onclick="toggleFullscreen()" class="text-xs bg-gray-100 text-gray-700 px-3 py-1.5 rounded hover:bg-gray-200 border border-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600 transition" title="Tela Cheia">
                                            <i class="fas fa-expand mr-1"></i>
                                        </button>
                                    </div>
                                </div>
                                <div id="editor-container" class="bg-white dark:bg-gray-800 rounded-lg shadow-inner border border-gray-300 dark:border-gray-600 overflow-hidden">
                                    <div id="editor" style="min-height: 400px; font-family: 'Montserrat', sans-serif;"></div>
                                </div>
                                <p class="text-xs text-gray-400 mt-2 flex items-center gap-1">
                                    <i class="fas fa-info-circle"></i> 
                                    <span>Para melhor desempenho, evite colar muitas imagens diretamente no texto.</span>
                                </p>
                            </div>

                            <div class="flex gap-4 items-center flex-wrap pt-6 mt-6 border-t dark:border-gray-700 sticky bottom-0 bg-white dark:bg-dark-card py-4 z-10">
                                <button type="button" id="save-button" class="bg-primary text-white py-3 px-8 rounded-lg hover:bg-primary-dark flex items-center justify-center font-bold shadow-lg transform transition hover:-translate-y-1 hover:shadow-xl min-w-[150px]">
                                    <i class="fas fa-paper-plane mr-2"></i> Publicar
                                </button>
                                <button type="button" id="draft-button" class="bg-gray-500 text-white py-3 px-6 rounded-lg hover:bg-gray-600 font-semibold shadow-md transition hover:-translate-y-0.5">
                                    <i class="fas fa-save mr-2"></i> Rascunho
                                </button>
                                <button type="button" onclick="generateSocialPost()" id="ai-social-btn" class="bg-purple-600 text-white py-3 px-6 rounded-lg hover:bg-purple-700 font-semibold shadow-md transition hover:-translate-y-0.5 flex items-center gap-2">
                                    <i class="fab fa-instagram"></i> Gerar Post Social
                                </button>
                                <button type="button" onclick="checkUnsavedChanges()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 font-medium ml-auto px-4">
                                    Cancelar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Lista de Notícias -->
                <div class="bg-white dark:bg-dark-card p-6 rounded-lg shadow-md min-h-[500px]">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <h2 class="text-2xl font-bold flex items-center gap-2">
                            <i class="fas fa-list text-primary dark:text-blue-400"></i> Gerenciar Notícias
                        </h2>
                        <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
                            <!-- Busca -->
                            <div class="relative w-full sm:w-64">
                                <input type="text" id="search-input" placeholder="Buscar por título..." class="w-full pl-10 pr-4 py-2 border dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-primary outline-none text-sm">
                                <i class="fas fa-search absolute left-3 top-2.5 text-gray-400"></i>
                            </div>
                            <button id="add-news-button" class="bg-green-600 text-white py-2 px-6 rounded-lg hover:bg-green-700 flex items-center justify-center gap-2 shadow-sm transition hover:scale-105 font-bold text-sm whitespace-nowrap">
                                <i class="fas fa-plus"></i> Nova Notícia
                            </button>
                        </div>
                    </div>
                    
                    <!-- Header da Tabela (Visual) -->
                    <div class="hidden md:grid grid-cols-12 gap-4 px-4 py-2 bg-gray-100 dark:bg-gray-800 rounded-t-lg text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                        <div class="col-span-1">Capa</div>
                        <div class="col-span-6">Detalhes</div>
                        <div class="col-span-2 text-center">Status</div>
                        <div class="col-span-3 text-right">Ações</div>
                    </div>
                    
                    <div id="news-list" class="space-y-2">
                        <!-- Skeleton Loading -->
                        <div class="animate-pulse space-y-3">
                            <div class="h-20 bg-gray-200 dark:bg-gray-700 rounded-lg w-full"></div>
                            <div class="h-20 bg-gray-200 dark:bg-gray-700 rounded-lg w-full"></div>
                            <div class="h-20 bg-gray-200 dark:bg-gray-700 rounded-lg w-full"></div>
                        </div>
                    </div>
                    
                    <div id="load-more-container" class="text-center mt-6 hidden">
                        <p class="text-gray-400 text-sm mb-2">Mostrando as últimas 50 notícias</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal de Crop (Capa) -->
    <div id="crop-modal" class="modal-overlay hidden">
        <div class="crop-container relative w-full max-w-4xl bg-white flex flex-col shadow-2xl rounded-xl">
            <h3 class="text-lg font-bold p-4 bg-white border-b flex justify-between items-center text-gray-800 rounded-t-xl">
                <span><i class="fas fa-crop-alt mr-2 text-primary"></i> Ajustar Capa</span>
                <button onclick="closeCropModal()" class="text-gray-400 hover:text-red-500 transition-colors"><i class="fas fa-times fa-lg"></i></button>
            </h3>
            <div class="bg-gray-900 flex-grow flex justify-center items-center overflow-hidden h-[60vh]">
                <img id="image-to-crop" src="" alt="Para recortar">
            </div>
            <div class="p-4 bg-gray-50 border-t flex justify-end gap-3 rounded-b-xl">
                <button onclick="closeCropModal()" class="px-5 py-2 text-gray-600 hover:bg-gray-200 rounded-lg font-medium transition-colors">Cancelar</button>
                <button onclick="confirmCrop()" class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark font-bold shadow-md transition-transform transform hover:-translate-y-0.5">Confirmar Recorte</button>
            </div>
        </div>
    </div>

    <!-- Modal de Inserção de Mídia (Editor) -->
    <div id="media-modal" class="modal-overlay hidden">
        <div class="bg-white dark:bg-dark-card w-full max-w-lg rounded-xl shadow-2xl p-6 transform transition-all scale-100">
            <h3 class="text-xl font-bold mb-4 border-b pb-3 dark:border-gray-700">Adicionar Mídia ao Texto</h3>
            
            <div class="flex gap-4 mb-6 border-b dark:border-gray-700">
                <button onclick="switchMediaTab('image')" id="tab-image" class="pb-2 border-b-2 border-primary text-primary font-bold transition-colors">Imagem</button>
                <button onclick="switchMediaTab('video')" id="tab-video" class="pb-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 transition-colors">Vídeo</button>
            </div>

            <!-- Tab Imagem -->
            <div id="content-image" class="animate-fade-in">
                <div class="space-y-4">
                    <button onclick="document.getElementById('editor-image-input').click()" class="w-full border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-xl p-8 text-center hover:bg-gray-50 dark:hover:bg-gray-800 transition cursor-pointer group">
                        <i class="fas fa-cloud-upload-alt fa-3x text-gray-400 group-hover:text-primary mb-3 transition-colors"></i>
                        <p class="font-semibold text-gray-700 dark:text-gray-300">Clique para enviar imagem</p>
                        <p class="text-xs text-gray-500">Será otimizada automaticamente</p>
                    </button>
                    <input type="file" id="editor-image-input" accept="image/*" class="hidden" onchange="handleEditorImageUpload(this)">
                    
                    <div class="relative py-2">
                        <div class="absolute inset-0 flex items-center"><div class="w-full border-t dark:border-gray-600"></div></div>
                        <div class="relative flex justify-center text-sm"><span class="px-2 bg-white dark:bg-dark-card text-gray-500">OU</span></div>
                    </div>
                    
                    <input type="url" id="editor-image-url" placeholder="Cole a URL da imagem aqui..." class="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 focus:ring-2 focus:ring-primary outline-none">
                </div>
            </div>

            <!-- Tab Video -->
            <div id="content-video" class="hidden animate-fade-in">
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-2 font-medium">Link do YouTube / Vimeo / Facebook:</p>
                <input type="url" id="editor-video-url" placeholder="https://www.youtube.com/watch?v=..." class="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 mb-4 focus:ring-2 focus:ring-primary outline-none">
                <div class="bg-blue-50 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300 p-4 rounded-lg text-sm flex gap-2">
                    <i class="fas fa-lightbulb mt-1"></i> 
                    <span>O vídeo será incorporado automaticamente no texto. Certifique-se que o link é público.</span>
                </div>
            </div>

            <div class="flex justify-end gap-3 mt-8">
                <button onclick="closeMediaModal()" class="px-5 py-2 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">Cancelar</button>
                <button onclick="confirmInsertMedia()" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold shadow-md">Inserir Mídia</button>
            </div>
        </div>
    </div>

    <!-- Modal Resultados IA -->
    <div id="ai-result-modal" class="modal-overlay hidden">
        <div class="bg-white dark:bg-dark-card rounded-xl shadow-2xl w-full max-w-lg p-6 flex flex-col max-h-[85vh]">
            <h3 id="ai-result-title" class="text-xl font-bold mb-4 text-gray-800 dark:text-white border-b dark:border-gray-700 pb-2">Resultado da IA</h3>
            
            <div class="flex-grow overflow-y-auto mb-4">
                <textarea id="ai-result-content" class="w-full h-48 p-4 border dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-800 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-primary outline-none resize-none font-mono text-sm" readonly></textarea>
                <div id="ai-list-container" class="hidden space-y-2"></div>
            </div>

            <div class="flex justify-end gap-3 pt-2">
                <button onclick="closeAiResult()" class="px-5 py-2 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">Fechar</button>
                <button id="copy-ai-btn" onclick="copyAiResult()" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-bold shadow-md flex items-center gap-2">
                    <i class="fas fa-copy"></i> Copiar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Delete -->
    <div id="delete-confirm-modal" class="modal-overlay hidden">
        <div class="bg-white dark:bg-dark-card rounded-xl shadow-2xl w-full max-w-sm p-8 text-center transform scale-100 transition-all">
            <div class="w-16 h-16 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-trash-alt fa-2x text-red-500"></i>
            </div>
            <h3 class="text-xl font-bold mb-2 text-gray-800 dark:text-white">Excluir Notícia?</h3>
            <p class="text-gray-600 dark:text-gray-300 mb-8 text-sm leading-relaxed">Essa ação removerá a notícia permanentemente do banco de dados. Você tem certeza?</p>
            <div class="flex justify-center gap-3">
                <button id="cancel-delete-btn" class="bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 px-5 py-2.5 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 font-medium transition-colors">Cancelar</button>
                <button id="confirm-delete-btn" class="bg-red-600 text-white px-5 py-2.5 rounded-lg hover:bg-red-700 font-bold shadow-md transition-colors">Sim, Excluir</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Unsaved Changes -->
    <div id="unsaved-modal" class="modal-overlay hidden">
        <div class="bg-white dark:bg-dark-card rounded-xl shadow-2xl w-full max-w-sm p-8 text-center">
            <div class="w-16 h-16 bg-yellow-100 dark:bg-yellow-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-exclamation-triangle fa-2x text-yellow-500"></i>
            </div>
            <h3 class="text-xl font-bold mb-2 text-gray-800 dark:text-white">Alterações não salvas!</h3>
            <p class="text-gray-600 dark:text-gray-300 mb-8 text-sm">Se você sair agora, perderá todo o conteúdo editado.</p>
            <div class="flex justify-center gap-3">
                <button onclick="closeUnsavedModal()" class="bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 px-5 py-2.5 rounded-lg hover:bg-gray-300 font-medium">Continuar Editando</button>
                <button onclick="forceCloseForm()" class="bg-red-600 text-white px-5 py-2.5 rounded-lg hover:bg-red-700 font-bold shadow-md">Sair sem Salvar</button>
            </div>
        </div>
    </div>
    
    <div id="toast-container" class="fixed top-5 right-5 z-50 space-y-3 pointer-events-none"></div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quill-image-resize-module@3.0.0/image-resize.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, serverTimestamp, query, orderBy, getDoc, getDocs, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // CONFIGURAÇÃO DA API GEMINI
        const apiKey = "AIzaSyBFfLBtPpxG2YyjS5JfKQ25zHqDqKlwxOU";
        
        const firebaseConfig = {
            apiKey: "AIzaSyDlV94hvPy5NIi6zCoSihsaMmoprudmaWQ",
            authDomain: "portal-noticias-ruda.firebaseapp.com",
            projectId: "portal-noticias-ruda",
            storageBucket: "portal-noticias-ruda.appspot.com",
            messagingSenderId: "520724881912",
            appId: "1:520724881912:web:a9f207b3235328cf34b60d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Estado do Formulário (Dirty Check)
        let isFormDirty = false;
        window.markDirty = () => { isFormDirty = true; };
        window.markClean = () => { isFormDirty = false; };
        
        // --- Configuração Avançada do Quill ---
        const Font = Quill.import('formats/font');
        Font.whitelist = ['sans-serif', 'serif', 'monospace', 'roboto-slab', 'lora', 'montserrat'];
        Quill.register(Font, true);
        
        const quill = new Quill('#editor', { 
            theme: 'snow', 
            placeholder: 'Comece a escrever a notícia aqui...', 
            modules: { 
                toolbar: {
                    container: [
                        [{ 'font': Font.whitelist }, { 'size': ['small', false, 'large', 'huge'] }],
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline', 'strike', 'blockquote'],
                        [{ 'color': [] }, { 'background': [] }],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }, { 'align': [] }],
                        ['link', 'clean']
                    ]
                },
                imageResize: { displaySize: true }
            } 
        });

        // Detectar mudanças no Quill
        quill.on('text-change', () => { markDirty(); });

        // --- FUNÇÕES DA GEMINI API ---
        async function callGemini(prompt) {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Erro API:", errorData);
                    throw new Error('Falha na resposta da IA.');
                }
                
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || null;
            } catch (error) {
                console.error("Erro Gemini:", error);
                showToast(error.message, "error");
                return null;
            }
        }

        window.generateSubtitle = async () => {
            const btn = document.getElementById('ai-subtitle-btn');
            const originalText = btn.innerHTML;
            const content = quill.getText().trim();
            const title = document.getElementById('title').value;

            if (content.length < 50) {
                showToast("Escreva mais conteúdo antes de gerar o resumo.", "info");
                return;
            }

            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;

            const prompt = `Atue como um editor chefe de um jornal local. Crie um subtítulo (linha fina) curto, direto e atrativo (máximo 160 caracteres) para uma notícia com o título "${title}" e o seguinte conteúdo: \n\n${content.substring(0, 2000)}\n\nResponda APENAS com o texto do subtítulo, sem aspas.`;

            const result = await callGemini(prompt);
            
            if (result) {
                const subtitleField = document.getElementById('subtitle');
                subtitleField.value = result.trim();
                updateCharCount(subtitleField, 'subtitle-count', 160);
                markDirty();
                showToast("Linha fina gerada com sucesso!");
            }

            btn.disabled = false;
            btn.innerHTML = originalText;
        };

        window.generateTags = async () => {
            const btn = document.getElementById('ai-tags-btn');
            const originalText = btn.innerHTML;
            const content = quill.getText().trim();

            if (content.length < 50) {
                showToast("Escreva conteúdo para sugerir tags.", "info");
                return;
            }

            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;

            const prompt = `Analise o texto abaixo e gere 5 tags (palavras-chave) relevantes, separadas por vírgula, para indexação desta notícia em um portal local. Responda APENAS com as tags, sem numeração: \n\n${content.substring(0, 1500)}`;

            const result = await callGemini(prompt);
            
            if (result) {
                document.getElementById('tags').value = result.trim();
                markDirty();
                showToast("Tags sugeridas!");
            }

            btn.disabled = false;
            btn.innerHTML = originalText;
        };

        window.generateTitleIdeas = async () => {
            const btn = document.getElementById('ai-title-btn');
            const originalText = btn.innerHTML;
            const content = quill.getText().trim();

            if (content.length < 50) {
                showToast("Escreva conteúdo para sugerir títulos.", "info");
                return;
            }

            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;

            const prompt = `Analise o texto e gere 3 sugestões de títulos jornalísticos (max 80 caracteres). Responda APENAS com os 3 títulos separados por uma quebra de linha, sem numeração ou marcadores: \n\n${content.substring(0, 1500)}`;

            const result = await callGemini(prompt);
            
            if (result) {
                const titles = result.split('\n').filter(t => t.trim().length > 0);
                showAiListResult("Sugestões de Título", titles, (selectedText) => {
                     document.getElementById('title').value = selectedText;
                     updateCharCount(document.getElementById('title'), 'title-count');
                     markDirty();
                     closeAiResult();
                     showToast("Título aplicado!");
                });
            }

            btn.disabled = false;
            btn.innerHTML = originalText;
        };

        window.generateSocialPost = async () => {
            const btn = document.getElementById('ai-social-btn');
            const originalText = btn.innerHTML;
            const content = quill.getText().trim();
            const title = document.getElementById('title').value;

            if (content.length < 50) {
                showToast("Escreva conteúdo para gerar o post.", "info");
                return;
            }

            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Gerando...`;

            const prompt = `Crie um post para Instagram/Facebook sobre esta notícia. O tom deve ser informativo e engajador para a comunidade local. \n\nTítulo: ${title}\nConteúdo: ${content.substring(0, 2000)}\n\nEstrutura do post:\n1. Título chamativo com emoji\n2. Resumo curto (3-4 linhas)\n3. Chamada para ação ("Leia mais no link da bio")\n4. Hashtags relevantes.\n\nResponda APENAS com o texto do post.`;

            const result = await callGemini(prompt);
            
            if (result) {
                showAiTextResult("Post para Redes Sociais", result);
            }

            btn.disabled = false;
            btn.innerHTML = originalText;
        };

        window.improveContent = async () => {
            const btn = document.getElementById('ai-review-btn');
            const originalText = btn.innerHTML;
            
            // Pega a seleção ou o texto todo
            const range = quill.getSelection();
            let textToImprove = "";
            let isSelection = false;

            if (range && range.length > 0) {
                textToImprove = quill.getText(range.index, range.length);
                isSelection = true;
            } else {
                textToImprove = quill.getText();
            }

            if (!textToImprove || textToImprove.trim().length < 10) {
                showToast("Selecione um texto ou escreva algo para revisar.", "info");
                return;
            }

            if (!isSelection && !confirm("Isso irá reescrever todo o texto atual para melhorá-lo. Deseja continuar?")) return;

            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Revisando...`;

            const prompt = `Atue como um jornalista experiente (revisor). Reescreva o seguinte texto para torná-lo mais claro, objetivo, profissional e com tom jornalístico informativo (norma culta pt-BR). Mantenha os fatos originais. Responda APENAS com o texto reescrito: \n\n${textToImprove.substring(0, 3000)}`;

            const result = await callGemini(prompt);

            if (result) {
                if (isSelection) {
                    quill.deleteText(range.index, range.length);
                    quill.insertText(range.index, result.trim());
                } else {
                    quill.setText(result.trim());
                }
                markDirty();
                showToast("Texto revisado pela IA!");
            }

            btn.disabled = false;
            btn.innerHTML = originalText;
        };

        // --- AI RESULT MODAL HELPERS ---
        const aiModal = document.getElementById('ai-result-modal');
        const aiTitle = document.getElementById('ai-result-title');
        const aiContent = document.getElementById('ai-result-content');
        const aiList = document.getElementById('ai-list-container');
        
        window.closeAiResult = () => aiModal.classList.add('hidden');
        
        window.showAiTextResult = (title, text) => {
            aiTitle.textContent = title;
            aiContent.value = text;
            aiContent.classList.remove('hidden');
            aiList.classList.add('hidden');
            aiModal.classList.remove('hidden');
        };

        window.showAiListResult = (title, items, callback) => {
            aiTitle.textContent = title;
            aiContent.classList.add('hidden');
            aiList.classList.remove('hidden');
            aiList.innerHTML = '';
            
            items.forEach(item => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left p-3 border dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-800 hover:bg-blue-50 dark:hover:bg-blue-900/30 transition-colors text-sm font-medium";
                btn.textContent = item;
                btn.onclick = () => callback(item);
                aiList.appendChild(btn);
            });
            
            aiModal.classList.remove('hidden');
        };
        
        window.copyAiResult = () => {
            if(!aiContent.classList.contains('hidden')) {
                aiContent.select();
                document.execCommand('copy'); // Fallback seguro
                showToast('Conteúdo copiado!');
            }
        };

        // --- COMPRESSÃO AUTOMÁTICA (Conteúdo e Colagem) ---
        function compressImage(file, callback) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    
                    const MAX_WIDTH = 800;
                    if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width;
                        width = MAX_WIDTH;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    let dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    callback(dataUrl);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        quill.root.addEventListener('paste', (e) => {
            const clipboardData = e.clipboardData || window.clipboardData;
            if (clipboardData && clipboardData.files && clipboardData.files.length > 0) {
                e.preventDefault();
                const file = clipboardData.files[0];
                if (file.type.startsWith('image/')) {
                    showToast('Processando imagem colada...', 'info');
                    compressImage(file, (dataUrl) => {
                        const range = quill.getSelection(true) || { index: quill.getLength() };
                        quill.insertEmbed(range.index, 'image', dataUrl);
                    });
                }
            }
        });

        // --- Auth ---
        onAuthStateChanged(auth, user => {
            const loginBtn = document.getElementById('login-button');
            const loginSpinner = document.getElementById('login-spinner');
            const loginText = document.getElementById('login-button-text');

            if (user) {
                document.getElementById('admin-panel').classList.remove('hidden');
                document.getElementById('login-section').classList.add('hidden');
                listenForNewsChanges();
                loadDashboardStats();
            } else {
                document.getElementById('admin-panel').classList.add('hidden');
                document.getElementById('login-section').classList.remove('hidden');
                if(loginBtn) {
                    loginBtn.disabled = false;
                    loginSpinner.classList.add('hidden');
                    loginText.textContent = 'Entrar';
                }
            }
        });

        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const btn = document.getElementById('login-button');
            const spinner = document.getElementById('login-spinner');
            const text = document.getElementById('login-button-text');
            
            btn.disabled = true;
            spinner.classList.remove('hidden');
            text.textContent = 'Autenticando...';

            signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value)
                .catch(err => {
                    document.getElementById('login-error').textContent = "Erro de login: Verifique e-mail e senha.";
                    btn.disabled = false;
                    spinner.classList.add('hidden');
                    text.textContent = 'Entrar';
                });
        });
        document.getElementById('logout-button').addEventListener('click', () => signOut(auth));

        // --- Stats ---
        async function loadDashboardStats() {
            try {
                const querySnapshot = await getDocs(collection(db, "news"));
                let totalNews = 0;
                const categories = {};
                querySnapshot.forEach(doc => {
                    const news = doc.data();
                    totalNews++;
                    const cat = news.category || 'Sem Categoria';
                    categories[cat] = (categories[cat] || 0) + 1;
                });
                document.getElementById('stats-total-news').textContent = totalNews;
                const ctx = document.getElementById('categories-chart').getContext('2d');
                if (window.myChart) window.myChart.destroy();
                
                const colors = ['#0D47A1', '#1565C0', '#1976D2', '#1E88E5', '#2196F3', '#42A5F5', '#64B5F6', '#90CAF9'];
                
                window.myChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(categories),
                        datasets: [{ 
                            data: Object.values(categories), 
                            backgroundColor: colors.slice(0, Object.keys(categories).length),
                            borderWidth: 0
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'right', labels: { boxWidth: 10, usePointStyle: true } }
                        }
                    }
                });
            } catch(e) { console.error("Erro stats", e); }
        }

        // ==========================================================
        //  LÓGICA DE CAPA (CROPPER)
        // ==========================================================
        let cropper;
        let originalFile = null;
        const imagePreview = document.getElementById('image-preview');
        const base64Input = document.getElementById('base64-image');
        const cropModal = document.getElementById('crop-modal');
        const imageToCrop = document.getElementById('image-to-crop');
        const reCropBtn = document.getElementById('re-crop-btn');

        document.getElementById('imageInput').addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                originalFile = e.target.files[0];
                openCropModal(originalFile);
            }
        });

        window.promptUrlImage = () => {
            const url = prompt("Cole a URL da imagem de capa:");
            if(url) {
                if(url.match(/\.(jpeg|jpg|gif|png)$/) != null || url.includes('http')) {
                    openCropModal(url);
                } else {
                    showToast('URL inválida. Tente um link direto de imagem.', 'error');
                }
            }
        }

        function openCropModal(src) {
            markDirty();
            if (src instanceof File) {
                const reader = new FileReader();
                reader.onload = (e) => startCropper(e.target.result);
                reader.readAsDataURL(src);
            } else {
                startCropper(src);
            }
        }

        function startCropper(src) {
            imageToCrop.src = src;
            imageToCrop.crossOrigin = "anonymous";
            cropModal.classList.remove('hidden');
            if (cropper) cropper.destroy();
            cropper = new Cropper(imageToCrop, { 
                aspectRatio: 16/9, 
                viewMode: 1, 
                autoCropArea: 1,
                dragMode: 'move'
            });
        }

        window.closeCropModal = () => { cropModal.classList.add('hidden'); if(cropper) cropper.destroy(); document.getElementById('imageInput').value = ''; };

        function getCroppedImage() {
            return new Promise((resolve) => {
                if (!cropper) return resolve(null);
                const canvas = cropper.getCroppedCanvas({ width: 1024, height: 576, imageSmoothingEnabled: true, imageSmoothingQuality: 'high' });
                let quality = 0.8;
                let dataUrl = canvas.toDataURL('image/jpeg', quality);
                while (dataUrl.length > 400000 && quality > 0.1) {
                    quality -= 0.1;
                    dataUrl = canvas.toDataURL('image/jpeg', quality);
                }
                resolve(dataUrl);
            });
        }

        window.confirmCrop = async () => {
            const dataUrl = await getCroppedImage();
            if (dataUrl) {
                imagePreview.src = dataUrl;
                imagePreview.classList.remove('hidden');
                document.getElementById('placeholder-text').classList.add('hidden');
                base64Input.value = dataUrl;
                reCropBtn.classList.remove('hidden');
                closeCropModal();
            }
        };

        window.reCropImage = () => {
            if (originalFile) openCropModal(originalFile);
            else if (base64Input.value) openCropModal(base64Input.value);
        }

        // ==========================================================
        //  LÓGICA DE MÍDIA NO EDITOR
        // ==========================================================
        const mediaModal = document.getElementById('media-modal');
        let activeMediaTab = 'image';

        window.insertMediaModal = () => {
            mediaModal.classList.remove('hidden');
            switchMediaTab('image');
        };

        window.closeMediaModal = () => {
            mediaModal.classList.add('hidden');
            document.getElementById('editor-image-url').value = '';
            document.getElementById('editor-video-url').value = '';
            document.getElementById('editor-image-input').value = '';
        };

        window.switchMediaTab = (tab) => {
            activeMediaTab = tab;
            document.getElementById('tab-image').className = tab === 'image' ? 'pb-2 border-b-2 border-primary text-primary font-bold transition-colors' : 'pb-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 transition-colors';
            document.getElementById('tab-video').className = tab === 'video' ? 'pb-2 border-b-2 border-primary text-primary font-bold transition-colors' : 'pb-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 transition-colors';
            document.getElementById('content-image').classList.toggle('hidden', tab !== 'image');
            document.getElementById('content-video').classList.toggle('hidden', tab !== 'video');
        };

        window.handleEditorImageUpload = (input) => {
            if (input.files && input.files[0]) {
                compressImage(input.files[0], (dataUrl) => {
                    const range = quill.getSelection(true) || { index: quill.getLength() };
                    quill.insertEmbed(range.index, 'image', dataUrl);
                    closeMediaModal();
                });
            }
        };

        window.confirmInsertMedia = () => {
            const range = quill.getSelection(true) || { index: quill.getLength() };
            if (activeMediaTab === 'image') {
                const url = document.getElementById('editor-image-url').value;
                if (url) {
                    quill.insertEmbed(range.index, 'image', url);
                    closeMediaModal();
                }
            } else {
                const url = document.getElementById('editor-video-url').value;
                if (url) {
                    let embedUrl = url;
                    if (url.includes('youtube.com/watch?v=')) embedUrl = `https://www.youtube.com/embed/${url.split('v=')[1].split('&')[0]}`;
                    else if (url.includes('youtu.be/')) embedUrl = `https://www.youtube.com/embed/${url.split('youtu.be/')[1]}`;
                    else if (url.includes('vimeo.com/')) embedUrl = `https://player.vimeo.com/video/${url.split('vimeo.com/')[1]}`;
                    quill.insertEmbed(range.index, 'video', embedUrl);
                    closeMediaModal();
                }
            }
        };

        window.toggleFullscreen = () => document.getElementById('editor-wrapper').classList.toggle('fullscreen');
        window.updateCharCount = (input, spanId, max) => {
            const count = input.value.length;
            const span = document.getElementById(spanId);
            span.textContent = count;
            if (max && count >= max) span.classList.add('text-red-500'); else span.classList.remove('text-red-500');
        };

        // ==========================================================
        //  SALVAR COM VERIFICAÇÃO DE TAMANHO
        // ==========================================================
        async function handleFormSubmit(status) {
            const btn = document.getElementById('save-button');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Verificando...`;

            try {
                let imageUrl = base64Input.value;
                const contentHtml = quill.root.innerHTML;
                
                // 1. Verificação de Tamanho Total (Firestore Limit 1MB)
                // String length ~= bytes. Safe margin: 950,000 bytes.
                let totalSize = (imageUrl ? imageUrl.length : 0) + contentHtml.length + 5000; // +5KB overhead
                
                console.log("Tamanho estimado:", totalSize);

                if (totalSize > 980000) {
                    // SE ESTIVER GRANDE DEMAIS:
                    // Tenta comprimir a capa agressivamente primeiro
                    if (imageUrl && imageUrl.length > 200000) {
                        btn.innerHTML = `<i class="fas fa-compress"></i> Comprimindo Capa...`;
                        
                        // Recria o canvas da capa para comprimir MUITO
                        const tempImg = new Image();
                        tempImg.src = imageUrl;
                        await new Promise(r => tempImg.onload = r);
                        
                        const canvas = document.createElement('canvas');
                        // Reduz resolução drasticamente se necessário
                        const scale = 0.7; 
                        canvas.width = tempImg.width * scale;
                        canvas.height = tempImg.height * scale;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(tempImg, 0, 0, canvas.width, canvas.height);
                        
                        imageUrl = canvas.toDataURL('image/jpeg', 0.5); // Qualidade 50%
                        base64Input.value = imageUrl;
                        
                        // Recalcula
                        totalSize = imageUrl.length + contentHtml.length + 5000;
                    }
                    
                    // Se AINDA estiver grande, é culpa do CONTEÚDO (imagens coladas no texto)
                    if (totalSize > 980000) {
                        throw new Error(`O conteúdo da notícia está muito pesado (${(totalSize/1024/1024).toFixed(2)}MB). O limite é 1MB. Tente remover algumas imagens do texto.`);
                    }
                }

                if (!imageUrl && status === 'published') throw new Error('Capa obrigatória para publicar.');

                const newsData = {
                    title: document.getElementById('title').value.trim(),
                    subtitle: document.getElementById('subtitle').value.trim(),
                    category: document.getElementById('category').value.trim(),
                    tags: document.getElementById('tags').value.split(',').map(t=>t.trim()).filter(t=>t),
                    imageUrl: imageUrl,
                    imageCredit: document.getElementById('imageCredit').value.trim(),
                    content: contentHtml,
                    status: status,
                    updatedAt: serverTimestamp(),
                };

                const id = document.getElementById('news-id').value;
                if (id) await updateDoc(doc(db, "news", id), newsData);
                else {
                    newsData.createdAt = serverTimestamp();
                    await addDoc(collection(db, "news"), newsData);
                }
                
                showToast(`Notícia ${id ? 'atualizada' : 'criada'} com sucesso!`);
                hideForm();
                loadDashboardStats();

            } catch (error) {
                console.error(error);
                showToast(error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        document.getElementById('save-button').addEventListener('click', () => handleFormSubmit('published'));
        document.getElementById('draft-button').addEventListener('click', () => handleFormSubmit('draft'));

        // --- Listagem & CRUD ---
        const newsList = document.getElementById('news-list');
        const searchInput = document.getElementById('search-input');
        let allNewsCache = [];

        function listenForNewsChanges() {
             const q = query(collection(db, "news"), orderBy("createdAt", "desc"));
            onSnapshot(q, (snapshot) => {
                allNewsCache = [];
                snapshot.forEach(doc => {
                    allNewsCache.push({ id: doc.id, ...doc.data() });
                });
                renderNewsList(allNewsCache);
            });
        }

        function renderNewsList(newsItems) {
            newsList.innerHTML = '';
            if (newsItems.length === 0) {
                newsList.innerHTML = `<div class="text-center py-10 text-gray-400 flex flex-col items-center"><i class="far fa-folder-open fa-3x mb-3"></i><p>Nenhuma notícia encontrada.</p></div>`;
                return;
            }
            
            newsItems.forEach(n => {
                const div = document.createElement('div');
                div.className = 'grid grid-cols-1 md:grid-cols-12 gap-4 items-center p-4 border dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-800 hover:bg-white dark:hover:bg-gray-700 transition-colors shadow-sm mb-2';
                
                const thumb = n.imageUrl || 'https://placehold.co/100x100?text=Sem+Capa';
                const date = n.createdAt ? (n.createdAt.toDate ? n.createdAt.toDate().toLocaleDateString('pt-BR') : 'Data inv.') : 'Sem data';

                div.innerHTML = `
                    <div class="col-span-12 md:col-span-1 flex justify-center md:justify-start">
                        <img src="${thumb}" class="w-16 h-16 object-cover rounded bg-gray-200 dark:bg-gray-600">
                    </div>
                    <div class="col-span-12 md:col-span-6 text-center md:text-left">
                        <h3 class="font-bold text-gray-800 dark:text-gray-200 text-base md:text-lg line-clamp-1" title="${n.title}">${n.title}</h3>
                        <div class="flex items-center justify-center md:justify-start gap-2 text-xs text-gray-500 dark:text-gray-400 mt-1">
                            <span class="bg-gray-200 dark:bg-gray-600 px-2 py-0.5 rounded">${n.category || 'Geral'}</span>
                            <span><i class="far fa-clock mr-1"></i> ${date}</span>
                        </div>
                    </div>
                    <div class="col-span-6 md:col-span-2 flex justify-center">
                        <span class="px-3 py-1 rounded-full text-xs font-bold uppercase ${n.status==='draft'?'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400':'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400'}">
                            ${n.status==='draft'?'Rascunho':'Publicado'}
                        </span>
                    </div>
                    <div class="col-span-6 md:col-span-3 flex justify-end gap-2">
                        <a href="noticia.html?id=${n.id}" target="_blank" class="text-gray-400 hover:text-primary p-2 transition-colors" title="Ver no site"><i class="fas fa-external-link-alt"></i></a>
                        <button class="edit-btn bg-blue-50 text-blue-600 hover:bg-blue-100 dark:bg-blue-900/20 dark:text-blue-400 dark:hover:bg-blue-900/40 p-2 rounded transition-colors" data-id="${n.id}" title="Editar"><i class="fas fa-edit"></i></button>
                        <button class="delete-btn bg-red-50 text-red-600 hover:bg-red-100 dark:bg-red-900/20 dark:text-red-400 dark:hover:bg-red-900/40 p-2 rounded transition-colors" data-id="${n.id}" title="Excluir"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                newsList.appendChild(div);
            });
        }
        
        searchInput.addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = allNewsCache.filter(n => 
                n.title.toLowerCase().includes(term) || 
                (n.category && n.category.toLowerCase().includes(term))
            );
            renderNewsList(filtered);
        });


        newsList.addEventListener('click', async (e) => {
            const btn = e.target.closest('button');
            if(!btn) return;
            const id = btn.dataset.id;
            
            if(btn.classList.contains('delete-btn')) {
                const modal = document.getElementById('delete-confirm-modal');
                modal.classList.remove('hidden');
                document.getElementById('confirm-delete-btn').onclick = async () => {
                    await deleteDoc(doc(db, "news", id));
                    modal.classList.add('hidden');
                    showToast('Notícia excluída.');
                };
                document.getElementById('cancel-delete-btn').onclick = () => modal.classList.add('hidden');
            } else if(btn.classList.contains('edit-btn')) {
                const docSnap = await getDoc(doc(db, "news", id));
                if(docSnap.exists()) {
                    const d = docSnap.data();
                    document.getElementById('news-id').value = id;
                    document.getElementById('title').value = d.title;
                    document.getElementById('subtitle').value = d.subtitle || '';
                    document.getElementById('category').value = d.category;
                    document.getElementById('tags').value = (d.tags||[]).join(', ');
                    document.getElementById('imageCredit').value = d.imageCredit || '';
                    quill.root.innerHTML = d.content;
                    
                    if(d.imageUrl) {
                        base64Input.value = d.imageUrl;
                        imagePreview.src = d.imageUrl;
                        imagePreview.classList.remove('hidden');
                        document.getElementById('placeholder-text').classList.add('hidden');
                        reCropBtn.classList.remove('hidden');
                    } else resetImage();
                    
                    showForm();
                    updateCharCount(document.getElementById('title'), 'title-count');
                    updateCharCount(document.getElementById('subtitle'), 'subtitle-count', 160);
                }
            }
        });

        // UI Helpers
        
        window.checkUnsavedChanges = () => {
            const unsavedModal = document.getElementById('unsaved-modal');
            if (!unsavedModal) return;
            
            if (isFormDirty) {
                unsavedModal.classList.remove('hidden');
            } else {
                hideForm();
            }
        };

        window.closeUnsavedModal = () => {
            const modal = document.getElementById('unsaved-modal');
            if (modal) modal.classList.add('hidden');
        };

        window.forceCloseForm = () => {
            const modal = document.getElementById('unsaved-modal');
            if (modal) modal.classList.add('hidden');
            hideForm();
        };

        window.showForm = () => { 
            const formContainer = document.getElementById('form-container');
            if(formContainer) {
                formContainer.classList.remove('hidden'); 
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        };
        
        window.hideForm = () => { 
            const formContainer = document.getElementById('form-container');
            if(formContainer) formContainer.classList.add('hidden'); 
            resetForm(); 
            markClean();
        };

        const resetImage = () => {
            const imgInput = document.getElementById('imageInput');
            const base64In = document.getElementById('base64-image');
            const prev = document.getElementById('image-preview');
            const place = document.getElementById('placeholder-text');
            const btn = document.getElementById('re-crop-btn');
            
            if(imgInput) imgInput.value = '';
            if(base64In) base64In.value = '';
            if(prev) prev.classList.add('hidden');
            if(place) place.classList.remove('hidden');
            if(btn) btn.classList.add('hidden');
        };
        const resetForm = () => {
            document.getElementById('news-form').reset();
            quill.setText('');
            document.getElementById('news-id').value = '';
            resetImage();
        };

        document.getElementById('add-news-button').addEventListener('click', () => { resetForm(); showForm(); });

        function showToast(msg, type='success') {
            const c = document.getElementById('toast-container');
            const d = document.createElement('div');
            const colorClass = type === 'error' ? 'bg-red-600' : (type === 'info' ? 'bg-blue-600' : 'bg-green-600');
            const iconClass = type === 'error' ? 'fa-exclamation-circle' : (type === 'info' ? 'fa-info-circle' : 'fa-check-circle');
            
            d.className = `p-4 rounded-lg shadow-xl text-white flex items-center gap-3 ${colorClass} transform transition-all duration-300 translate-x-full border border-white/20`;
            d.innerHTML = `<i class="fas ${iconClass}"></i><span class="font-medium">${msg}</span>`;
            c.appendChild(d);
            
            requestAnimationFrame(() => d.classList.remove('translate-x-full'));
            setTimeout(() => {
                d.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => d.remove(), 300);
            }, 4000);
        }
    </script>
    <script src="scripts/main.js"></script>
</body>
</html>